<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Alex Monterubio" />
  <title>RLH Theatre Allocation ‚Äî Alex Monterubio</title>
  <style>
    @media print {
      @page { size: A3 portrait; margin: 1cm; }
      body { width: 29.7cm; height: 42cm; margin: 1cm; }
      .hide-on-print, .hide-on-print * { display: none !important; }
      .print-header { display: block !important; margin-bottom: 10px; }
      input[type="date"] { border: none; background: transparent; }
    }

    body { font-family: Arial, sans-serif; margin: 5px; font-size: 16px; }

    .header-line { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .header-title { display: flex; align-items: center; font-size: 20px; }
    .header-title span { margin-left: 8px; font-weight: bold; }
    .header-title input[type="date"] { margin-left: 8px; font-size: 20px; padding: 4px 6px; }

    .button-group button { margin-left: 5px; font-size: 20px; padding: 6px 10px; }

    .grid-container { display: grid; grid-template-columns: 38% 38% 24%; gap: 4px; }
    .column { display: flex; flex-direction: column; gap: 2px; }

    .stacked-label { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 4px; }
    .stacked-row { display: flex; align-items: center; width: 100%; margin-bottom: 4px; }
    .stacked-item-h1, .stacked-item-h3 { font-size: 16px; font-weight: bold; color: #0074cc; margin-right: 8px; }
    .stacked-input { width: 100%; padding: 4px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    .stacked-input.indented { margin-left: calc(18px + 8px + 33px); }

    .theatre-block { border: 1px solid #333; background-color: #ffffff; display: grid; grid-template-columns: 1fr 2fr; }

    .left-cell { background-color: #d1e7f5; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; font-size: 20px; padding: 4px; border-right: 1px solid #333; text-align: center; cursor: pointer; }

    .speciality-row { margin-top: 2px; text-align: center; font-size: 18px; display: flex; flex-direction: column; align-items: center; }
    .speciality-row select.speciality-select, .speciality-row select.session-select { width: 100%; font-size: 18px; background: transparent; border: none; appearance: none; font-weight: bold; text-align: center; }

    .right-cell { display: flex; flex-direction: column; justify-content: flex-start; padding: 2px; font-size: 16px; }

    .staff-entry { display: flex; justify-content: space-between; align-items: center; margin: 1px 0; }
    .staff-entry span.name { font-size: 16px; flex: 1; margin-left: 2px; }

    .closed { background-color: red; color: white; font-weight: bold; text-align: center; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 50px; padding: 10px; }

    .control-buttons { font-size: 18px; margin-left: 2px; }

    button { margin: 5px 2px; }

    .simple-block { border: 1px solid #333; background-color: #ffffff; padding: 10px; font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 12px; min-height: 40px; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ccc; }
    th { background-color: #f0f0f0; }

    .role-selector { display: flex; flex-direction: column; align-items: flex-start; padding: 4px; margin-bottom: 8px; }

    .theatre-block.selected { outline: 3px solid #0074cc; box-shadow: 0 0 8px #0074cc; }

    .round-icon-button { width: 40px; height: 40px; font-size: 16px; border: none; border-radius: 6px; padding: 0; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; line-height: 1; }
    .purple-button { background-color: #6a0dad; color: white; }
    .purple-button:hover { background-color: #5a0099; }

    .parsed-roster-header, .parsed-roster-row { display: flex; font-size: 16px; padding: 8px 0; }
    .parsed-roster-cell { flex: 1; padding: 6px 10px; }
    .parsed-roster-header { font-weight: bold; background-color: #005EB8; color: white; border-bottom: 2px solid #003C71; }
    .parsed-roster-row { border-bottom: 1px solid #ccc; align-items: center; }
    .parsed-roster-actions { display: flex; gap: 6px; }

    footer { margin-top: 24px; text-align: center; font-size: 14px; color: #444; }
  </style>
</head>
<body>
  <div class="header-line" style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background-color: #f0f0f0; border-radius: 6px; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
    <div style="font-size: 30px; font-weight: bold;">RLH Theatre Allocation</div>
    <div class="no-print" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
      <strong style="font-size: 18px;">Add/Remove Staff Role:</strong>
      <label for="theatre-select" style="font-size: 18px;">Theatre:</label>
      <select id="theatre-select" class="stacked-input" style="font-size: 16px; width: 140px;">
        <option value=""></option>
        <option>Theatre 1</option><option>Theatre 2</option><option>Theatre 3</option>
        <option>Theatre 4</option><option>Theatre 5</option><option>Theatre 6</option>
        <option>Theatre 7</option><option>Theatre 8</option><option>Theatre 9</option>
        <option>Theatre 10</option><option>Theatre 11</option><option>Theatre 12</option>
        <option>ACAD 1</option><option>ACAD 2</option><option>ACAD 3</option>
        <option>ACAD 4</option><option>ACAD 5</option><option>ACAD 6</option>
        <option>ACAD 7</option><option>ACAD 8</option>
        <option>Mile End</option><option>Night</option><option>MD</option>
      </select>
      <label for="role-select" style="font-size: 18px;">Role:</label>
      <select id="role-select" class="stacked-input" style="font-size: 16px; width: 140px;">
        <option value=""></option>
        <option value="Scrub N/P">Scrub N/P</option>
        <option value="HCA">HCA</option>
        <option value="Anaes N/P">Anaes N/P</option>
        <option value="Cell Salvage">Cell Salvage</option>
      </select>
      <button onclick="addStaffToTheatre()" class="round-icon-button purple-button">Ôºã</button>
      <button onclick="removeStaffFromTheatre()" class="round-icon-button purple-button">‚àí</button>
    </div>
  </div>

  <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px;">
    <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
      <span id="dayLabel" style="font-size: 18px;">Saturday</span>
      <input type="date" id="customDate" style="font-size: 18px; padding: 6px;" />
      <button onclick="document.getElementById('fileInputScrub').click()" class="no-print" style="background-color:#005EB8; color:white; padding:8px 12px; border:none; border-radius:4px;">Upload Scrub Daily Staff Roster</button>
      <span id="scrubUploadName" class="no-print" style="min-width: 260px; color: green; font-size: 16px;">&nbsp;</span>
      <button id="clearScrubBtn" onclick="clearUpload('fileInputScrub', 'scrubUploadName', 'scrubStatusLabel')" class="no-print" style="display:none; background-color:#d9534f; color:white; padding:8px 12px; border:none; border-radius:4px;">Clear</button>
      <button id="viewStaffBtn" onclick="openHealthRosterWindow()" class="no-print" style="display:none; background-color:purple; color:white; padding:8px 12px; border:none; border-radius:4px;">üë• View Full Staff List</button>
      <div class="no-print" style="margin-left:auto; display: flex; gap: 10px;">
        <button onclick="window.print()" style="background-color:#005EB8; color:white; padding:8px 12px; border:none; border-radius:4px;">üñ®Ô∏è Print</button>
        <button onclick="saveCurrentViewWithState()">üíæ Save</button>
      </div>
    </div>

    <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-left: 269px;">
      <button onclick="document.getElementById('fileInputODP').click()" class="no-print" style="background-color:#005EB8; color:white; padding:8px 12px; border:none; border-radius:4px;">Upload Anaes Daily Staff Roster</button>
      <span id="odpUploadName" class="no-print" style="min-width: 260px; color: green; font-size: 16px;">&nbsp;</span>
      <button id="clearODPBtn" onclick="clearUpload('fileInputODP', 'odpUploadName', 'odpStatusLabel')" class="no-print" style="display:none; background-color:#d9534f; color:white; padding:8px 12px; border:none; border-radius:4px;">Clear</button>
      <button id="autoAllocateBtn" onclick="alert('‚ö†Ô∏è Feature not yet available');" class="no-print" style="display:none; background-color:#28a745; color:white; padding:8px 12px; border:none; border-radius:4px;">‚ö° Auto-Allocate Staff</button>
    </div>

    <input type="file" id="fileInputScrub" accept=".xlsx,.xls" style="display:none;" onchange="handleExcelUpload(this, 'scrubUploadName', 'scrubStatusLabel', 'Scrub N/P')" />
    <input type="file" id="fileInputODP" accept=".xlsx,.xls" style="display:none;" onchange="handleExcelUpload(this, 'odpUploadName', 'odpStatusLabel', 'Anaes N/P')" />
  </div>

  <div class="grid-container" id="gridContainer"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    function cleanupBeforeSaving() {
      const seen = new Set();
      document.querySelectorAll("#final-export-content .theatre-block").forEach(block => {
        const theatreKey = block.getAttribute("data-theatre");
        if (seen.has(theatreKey)) {
          block.remove();
        } else {
          const hasAssigned = block.querySelector(".staff-entry span")?.textContent.trim();
          if (!hasAssigned) {
            block.remove();
          } else {
            seen.add(theatreKey);
          }
        }
      });
    }

    function saveAsHTML() {
      const exportContent = document.querySelector("#final-export-content");
      if (!exportContent) { alert("Export content not found."); return; }
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const filename = `RLH Theatre Allocation - ${yyyy}-${mm}-${dd}.html`;
      const fullHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <meta name="author" content="Alex Monterubio" />
          <title>${filename}</title>
          <style>${[...document.querySelectorAll("style")].map(s => s.innerHTML).join("\n")}</style>
        </head>
        <body>${exportContent.outerHTML}</body>
        </html>`;
      const blob = new Blob([fullHTML], { type: "text/html" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function addStaffToTheatre() {
      const theatre = document.getElementById("theatre-select").value;
      const role = document.getElementById("role-select").value;
      if (!theatre || !role) return;
      const theatreBlocks = Array.from(document.querySelectorAll(".theatre-block"));
      const targetBlock = theatreBlocks.find(block => block.querySelector(".left-cell div")?.textContent.trim() === theatre);
      if (!targetBlock) return;
      const staffList = targetBlock.querySelector(".right-cell");
      if (!staffList) return;
      const nameElements = Array.from(staffList.querySelectorAll(".staff-entry .name"));
      const matchingRoles = nameElements.filter(el => el.textContent.replace(/‚≠ê/g, '').trim().startsWith(role));
      const roleCount = matchingRoles.length;
      const nextRoleLabel = `${role} ${roleCount + 1}`;
      const staffEntry = document.createElement("div");
      staffEntry.className = "staff-entry";
      staffEntry.innerHTML = `<span class="name">${nextRoleLabel}</span>`;
      staffEntry.setAttribute("data-role", nextRoleLabel);
      staffEntry.setAttribute("data-role-label", nextRoleLabel);
      staffEntry.setAttribute("data-assigned", "false");
      staffEntry.classList.add("staff-name");
      if (matchingRoles.length > 0) {
        const lastMatch = matchingRoles[matchingRoles.length - 1].parentElement;
        lastMatch.after(staffEntry);
      } else {
        staffList.appendChild(staffEntry);
      }
      if (window.parsedRosterWindow && !window.parsedRosterWindow.closed) {
        window.parsedRosterWindow.postMessage({ type: "newRoleAdded", payload: { theatre, role: nextRoleLabel } }, "*");
      }
    }

    function removeStaffFromTheatre() {
      const theatre = document.getElementById("theatre-select").value;
      const role = document.getElementById("role-select").value;
      if (!theatre || !role) return;
      const theatreBlocks = Array.from(document.querySelectorAll(".theatre-block"));
      const targetBlock = theatreBlocks.find(block => block.querySelector(".left-cell div")?.textContent.trim() === theatre);
      if (!targetBlock) return;
      const staffList = targetBlock.querySelector(".right-cell");
      if (!staffList) return;
      const matchingEntries = Array.from(staffList.querySelectorAll(".staff-entry .name")).filter(el => el.textContent.replace(/‚≠ê/g, '').trim().startsWith(role));
      if (matchingEntries.length > 0) {
        const last = matchingEntries[matchingEntries.length - 1].parentElement;
        last.remove();
      }
    }
  </script>

  <script>
    function addTheatre() {
      if (!selectedBlock) return alert("Click a theatre block to select it first.");
      const role = prompt("Enter a role to add (e.g. Scrub N/P, HCA, Anaes N/P, Cell Salvage):");
      if (role && role.trim()) {
        const staffList = selectedBlock.querySelector('.staff-list');
        addStaffEntry(staffList, role.trim());
      }
    }
    function removeTheatre() {
      if (!selectedBlock) return alert("Click a theatre block to select it first.");
      const staffList = selectedBlock.querySelector('.staff-list');
      if (staffList.lastChild) staffList.removeChild(staffList.lastChild);
    }
  </script>

  <script>
    function downloadCSV() {
      let csvContent = "data:text/csv;charset=utf-8,Theatre,Speciality,Session Count,Staff\n";
      const blocks = document.querySelectorAll('.theatre-block');
      blocks.forEach(block => {
        const theatre = block.querySelector('.left-cell div').textContent.trim();
        const specialitySelect = block.querySelector('.speciality-select');
        const sessionSelect = block.querySelector('.session-select');
        let specialityWithSession = '';
        if (specialitySelect && sessionSelect) {
          const speciality = specialitySelect.value;
          const sessionCount = sessionSelect.value;
          specialityWithSession = `${speciality} ${sessionCount}`;
        } else {
          specialityWithSession = 'N/A';
        }
        const staffLines = Array.from(block.querySelectorAll('.staff-entry .name')).map(div => div.innerText).join(' | ');
        csvContent += `${theatre},${specialityWithSession},,"${staffLines}"\n`;
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "theatre_roster.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    let selectedBlock = null;
    function highlightSelectedBlock(block) {
      document.querySelectorAll('.theatre-block').forEach(b => b.classList.remove('selected'));
      block.classList.add('selected');
      selectedBlock = block;
    }
    document.addEventListener('click', function(e) {
      const block = e.target.closest('.theatre-block');
      if (block) { highlightSelectedBlock(block); }
    });
    document.getElementById('role-select').addEventListener('change', function() {
      const role = this.value;
      if (role && selectedBlock) {
        const staffList = selectedBlock.querySelector('.staff-list');
        addStaffEntry(staffList, role);
        this.selectedIndex = 0;
      }
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const dayLabel = document.getElementById("dayLabel");
      const customDate = document.getElementById("customDate");
      function updateDayLabel(dateValue) {
        const date = dateValue ? new Date(dateValue) : new Date();
        const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        if (!isNaN(date)) { dayLabel.textContent = days[date.getDay()]; }
      }
      const today = new Date();
      customDate.valueAsDate = today;
      updateDayLabel(today);
      customDate.addEventListener("change", function () { updateDayLabel(this.value); });

      function createTheatreBlock(label) {
        const block = document.createElement("div");
        block.className = "theatre-block";
        block.setAttribute("data-theatre", label);
        block.setAttribute("data-label", label);
        const left = document.createElement("div");
        left.className = "left-cell";
        if (label === "MD" || label === "Night") {
          left.innerHTML = `<div>${label}</div>`;
        } else if (label === "Theatre 7" || label === "Theatre 12") {
          left.innerHTML = `
            <div onclick="allocateStaffToTheatre('${label}', this)" style="width:100%">${label}</div>
            <div class='speciality-row'>
              <select class='speciality-select' disabled><option value='EMERGENCY' selected>EMERGENCY</option></select>
              <select class='session-select'>
                <option value=''></option>
                <option value='AM only'>AM only</option>
                <option value='PM only'>PM only</option>
                <option value='PM+Evening'>PM+Evening</option>
                <option value='2 Sessions'>2 Sessions</option>
                <option value='3 Sessions'>3 Sessions</option>
              </select>
            </div>`;
        } else {
          left.innerHTML = `
            <div onclick="allocateStaffToTheatre('${label}', this)" style="width:100%">${label}</div>
            <div class='speciality-row'>
              <select class='speciality-select'>
                <option value=''>Speciality ‚ñø</option>
                <option value='Robotic'>Robotic ENT</option>
                <option value='Robotic'>Robotic HPB</option>
                <option value='Robotic'>Robotic Colorectal</option>
                <option value='Robotic'>Robotic GYO</option>
                <option value='Robotic'>Robotic Urology</option>
                <option value='ENT'>ENT</option>
                <option value='UGI'>UGI</option>
                <option value='HPB'>HPB</option>
                <option value='Colorectal'>Colorectal</option>
                <option value='GYO'>GYO</option>
                <option value='Ortho Trauma'>Ortho Trauma</option>
                <option value='Neuro Trauma'>Neuro Trauma</option>
                <option value='Neuro Cranial'>Neuro (Cranial)</option>
                <option value='Gynae Fertility'>Gynae Fertility</option>
                <option value='Vascular'>Vascular</option>
                <option value='Plastics Elective'>Plastics Elective</option>
                <option value='Plastics BB list'>Plastics BB List</option>
                <option value='Ortho Elective Joints'>Ortho Elective Joints</option>
                <option value='Ortho Spine'>Ortho Spine</option>
                <option value='Renal'>Renal</option>
                <option value='Urology'>Urology</option>
                <option value='Optha'>Optha</option>
                <option value='Special Care'>Special Care</option>
                <option value='Live Donor'>Live Donor</option>
                <option value='HIPEC'>HIPEC</option>
              </select>
              <select class='session-select'>
                <option value=''>Sessions ‚ñø</option>
                <option value='Theatre Closed'>Theatre Closed</option>
                <option value='AM only'>AM only</option>
                <option value='PM only'>PM only</option>
                <option value='PM+Evening'>PM+Evening</option>
                <option value='2 Sessions'>2 Sessions</option>
                <option value='3 Sessions'>3 Sessions</option>
              </select>
            </div>`;
        }
        document.querySelectorAll('.session-select').forEach(select => {
          select.addEventListener('change', () => {
            if (parsedStaffData.length > 0) {
              clearAllAssignments();
              autoAssignTheatre(parsedStaffData);
            }
          });
        });
        setTimeout(() => {
          const sessionSelect = block.querySelector(".session-select");
          if (sessionSelect) {
            sessionSelect.addEventListener("change", () => {
              const isClosed = sessionSelect.value === "Theatre Closed";
              updateTheatreClosed(label, isClosed);
            });
          }
        }, 0);
        const right = document.createElement("div");
        right.className = "right-cell";
        const staffList = document.createElement("div");
        staffList.className = "staff-list";
        ["Scrub N/P", "HCA", "Anaes N/P"].forEach((role) => addStaffEntry(staffList, role));
        right.appendChild(staffList);
        block.appendChild(left);
        block.appendChild(right);
        return block;
      }

      function updateTheatreClosedStatus(block) {
        const sessionSelect = block.querySelector('.session-select');
        if (!sessionSelect) return;
        sessionSelect.addEventListener('change', function () {
          const value = this.value;
          const rightCell = block.querySelector('.right-cell');
          if (!rightCell) return;
          if (value === "Theatre Closed") {
            rightCell.innerHTML = `<div style="background-color:#770016;color:black;font-size:36px;font-weight:bold;text-align:center;display:flex;align-items:center;justify-content:center;height:100px;border-radius:6px;width:100%">CLOSED</div>`;
          } else {
            const staffList = document.createElement("div");
            staffList.className = "staff-list";
            const label = block.getAttribute("data-theatre") || "";
            if (label === "Theatre 7" || label === "Theatre 12") {
              for (let j = 0; j < 3; j++) addStaffEntry(staffList, 'Scrub N/P');
              addStaffEntry(staffList, 'HCA');
              addStaffEntry(staffList, 'Anaes N/P');
            } else {
              for (let j = 0; j < 2; j++) addStaffEntry(staffList, 'Scrub N/P');
              addStaffEntry(staffList, 'HCA');
              addStaffEntry(staffList, 'Anaes N/P');
            }
            rightCell.innerHTML = "";
            rightCell.appendChild(staffList);
          }
        });
      }

      function addStaffEntry(container, role) {
        const entry = document.createElement("div");
        entry.className = "staff-entry";
        const existing = Array.from(container.querySelectorAll('.staff-entry .name'));
        const count = existing.filter(el => el.textContent.trim().startsWith(role)).length + 1;
        const numberedRole = `${role} ${count}`;
        entry.innerHTML = `<span class='name'>${numberedRole}</span>`;
        entry.setAttribute("data-role", numberedRole);
        container.appendChild(entry);
      }

      const gridContainer = document.getElementById("gridContainer");
      const column1 = document.createElement("div");
      column1.id = "column1";
      column1.className = "column";
      const headerBlock = document.createElement("div");
      headerBlock.textContent = "4th Floor";
      headerBlock.style.backgroundColor = "#e0f0ff";
      headerBlock.style.color = "#000";
      headerBlock.style.padding = "16px 12px";
      headerBlock.style.borderRadius = "10px";
      headerBlock.style.marginBottom = "12px";
      headerBlock.style.display = "flex";
      headerBlock.style.justifyContent = "center";
      headerBlock.style.alignItems = "center";
      headerBlock.style.fontWeight = "bold";
      headerBlock.style.fontSize = "1.5rem";
      headerBlock.style.border = "2px solid #444";
      headerBlock.style.boxShadow = "inset 0 2px 4px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1)";
      column1.appendChild(headerBlock);
      gridContainer.appendChild(column1);

      const block1490 = document.createElement("div");
      block1490.className = "theatre-block";
      block1490.setAttribute("data-theatre", "1490");
      const left1490 = document.createElement("div");
      left1490.className = "left-cell";
      left1490.innerHTML = `<div>1490</div>`;
      const right1490 = document.createElement("div");
      right1490.className = "right-cell";
      const dropdownWrapper = document.createElement("div");
      dropdownWrapper.className = "stacked-label";
      const select = document.createElement("select");
      select.id = "dropdown-1490";
      select.className = "stacked-input";
      select.innerHTML = `<option value=""></option><option>Upload DSR</option>`;
      let previousName = "";
      select.onchange = () => {
        const selectedValue = select.value;
        const isDefault = selectedValue === "" || selectedValue === "-- Select Staff --";
        if (isDefault && previousName) {
          window.postMessage({ type: "unassignDesignation", name: previousName }, "*");
          allocatedStaff.delete(previousName);
          previousName = "";
          return;
        }
        const nameWithoutShift = selectedValue.replace(/\(.*?\)/, "").trim();
        const nameParts = nameWithoutShift.split(" ");
        const currentName = nameParts.slice(-2).join(" ");
        if (currentName) {
          if (previousName && previousName !== currentName) {
            window.postMessage({ type: "unassignDesignation", name: previousName }, "*");
            allocatedStaff.delete(previousName);
          }
          window.postMessage({ type: "updateDesignation", name: currentName, theatre: "1490" }, "*");
          allocatedStaff.add(currentName);
          previousName = currentName;
        }
      };
      dropdownWrapper.appendChild(select);
      right1490.appendChild(dropdownWrapper);
      block1490.appendChild(left1490);
      block1490.appendChild(right1490);
      column1.appendChild(block1490);

      const block1494 = document.createElement("div");
      block1494.className = "theatre-block";
      block1494.setAttribute("data-theatre", "1494");
      const left1494 = document.createElement("div");
      left1494.className = "left-cell";
      left1494.innerHTML = `<div>1494</div>`;
      const right1494 = document.createElement("div");
      right1494.className = "right-cell";
      const dropdownWrapper1494 = document.createElement("div");
      dropdownWrapper1494.className = "stacked-label";
      const select1494 = document.createElement("select");
      select1494.id = "dropdown-1494";
      select1494.className = "stacked-input";
      select1494.innerHTML = `<option value=""></option><option>Upload DSR</option>`;
      dropdownWrapper1494.appendChild(select1494);
      right1494.appendChild(dropdownWrapper1494);
      block1494.appendChild(left1494);
      block1494.appendChild(right1494);
      column1.appendChild(block1494);
      let previousName1494 = "";
      select1494.onchange = () => {
        const selectedValue = select1494.value;
        const isDefault = selectedValue === "" || selectedValue === "-- Select Staff --";
        if (isDefault && previousName1494) {
          window.postMessage({ type: "unassignDesignation", name: previousName1494 }, "*");
          allocatedStaff.delete(previousName1494);
          previousName1494 = "";
          return;
        }
        const nameWithoutShift = selectedValue.replace(/\(.*?\)/, "").trim();
        const nameParts = nameWithoutShift.split(" ");
        const currentName = nameParts.slice(-2).join(" ");
        if (currentName) {
          if (previousName1494 && previousName1494 !== currentName) {
            window.postMessage({ type: "unassignDesignation", name: previousName1494 }, "*");
            allocatedStaff.delete(previousName1494);
          }
          window.postMessage({ type: "updateDesignation", name: currentName, theatre: "1494" }, "*");
          allocatedStaff.add(currentName);
          previousName1494 = currentName;
        }
      };

      [...Array(12).keys()].forEach((i) => {
        const block = createTheatreBlock(`Theatre ${i + 1}`);
        const staffList = block.querySelector('.staff-list');
        if (`Theatre ${i + 1}` === 'Theatre 7' || `Theatre ${i + 1}` === 'Theatre 12') {
          staffList.innerHTML = '';
          for (let j = 0; j < 3; j++) addStaffEntry(staffList, 'Scrub N/P');
          addStaffEntry(staffList, 'HCA');
          addStaffEntry(staffList, 'Anaes N/P');
        } else {
          staffList.innerHTML = '';
          for (let j = 0; j < 2; j++) addStaffEntry(staffList, 'Scrub N/P');
          addStaffEntry(staffList, 'HCA');
          addStaffEntry(staffList, 'Anaes N/P');
        }
        column1.appendChild(block);
        updateTheatreClosedStatus(block);
      });

      const column2 = document.createElement("div");
      column2.id = "column2";
      column2.className = "column";
      const thirdFloorHeader = document.createElement("div");
      thirdFloorHeader.textContent = "3rd Floor";
      thirdFloorHeader.style.backgroundColor = "#e0f0ff";
      thirdFloorHeader.style.color = "#000";
      thirdFloorHeader.style.padding = "16px 12px";
      thirdFloorHeader.style.borderRadius = "10px";
      thirdFloorHeader.style.marginBottom = "12px";
      thirdFloorHeader.style.display = "flex";
      thirdFloorHeader.style.justifyContent = "center";
      thirdFloorHeader.style.alignItems = "center";
      thirdFloorHeader.style.fontWeight = "bold";
      thirdFloorHeader.style.fontSize = "1.5rem";
      thirdFloorHeader.style.border = "2px solid #444";
      thirdFloorHeader.style.boxShadow = "inset 0 2px 4px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1)";
      column2.appendChild(thirdFloorHeader);
      gridContainer.appendChild(column2);

      const column3 = document.createElement("div");
      column3.className = "column";
      column3.style.marginTop = "76px";

      const staffAllocations = {};
      window.addEventListener("message", (e) => {
        if (e.data?.type !== "allocateStaffToTheatre") return;
        const { person, theatre, role } = e.data;
        if (!person?.name || !person?.shiftTime || !theatre || !role) return;
        if (staffAllocations[person.name]) { alert(`${person.name} is already allocated to ${staffAllocations[person.name]}. Please unallocate them first.`); return; }
        window.addEventListener("message", (event) => {
          if (event.data?.type === "updateAllocatedStaff") {
            const allocatedList = event.data.payload || [];
            updateDropdownsFromAllocatedList(allocatedList);
          }
        });
        function updateDropdownsFromAllocatedList(allocatedList) {
          const dropdowns = document.querySelectorAll('[id^="dropdown-"], [id^="md-staff-"], [id^="floaters-staff-"]');
          dropdowns.forEach(dropdown => {
            const currentValue = dropdown.value;
            const isStillValid = currentValue && !allocatedList.includes(currentValue);
            dropdown.innerHTML = `<option value="">-- Select Staff --</option>`;
            parsedRosterData.forEach(person => {
              const label = `${person.title} ${person.name} (${person.shiftTime})`;
              if (!allocatedList.includes(label) || (isStillValid && label === currentValue)) {
                dropdown.appendChild(new Option(label, label));
              }
            });
            dropdown.value = isStillValid ? currentValue : "";
          });
        }
        const block = document.querySelector(`.theatre-block[data-theatre="${theatre}"]`);
        const entries = block ? block.querySelectorAll(".staff-entry") : [];
        for (const entry of entries) {
          const nameSpan = entry.querySelector(".name");
          if (!nameSpan) continue;
          const originalLabel = entry.getAttribute("data-role");
          if (!originalLabel || !originalLabel.startsWith(role)) continue;
          const currentContent = nameSpan.textContent.trim();
          if (currentContent !== originalLabel) continue;
          nameSpan.innerHTML = `<span class="clickable-staff name" data-name="${person.name}" data-shift="${person.shiftTime}"><strong>${person.title} ${person.name}</strong> (${person.shiftTime})</span>`;
          entry.setAttribute("data-role", originalLabel);
          staffAllocations[person.name] = theatre;
          e.source.postMessage({ type: "updateDesignation", name: person.name, theatre }, "*");
          return;
        }
        alert(`No available slot found in ${theatre} for ${role}.`);
        const dropdowns = { "1490": document.getElementById("dropdown-1490"), "1494": document.getElementById("dropdown-1494"), "45871": document.getElementById("dropdown-45871"), "Blank": document.getElementById("dropdown-blank") };
        if (dropdowns[theatre]) {
          const dropdown = dropdowns[theatre];
          const label = `${person.title} ${person.name} (${person.shiftTime})`;
          if (![...dropdown.options].some(opt => opt.value === label)) { dropdown.appendChild(new Option(label, label)); }
          dropdown.value = label;
          staffAllocations[person.name] = theatre;
          e.source.postMessage({ type: "updateDesignation", name: person.name, theatre }, "*");
          return;
        }
        if (theatre === "MD") {
          const mdDropdowns = Array.from(document.querySelectorAll('[id^="md-staff-"]'));
          const label = `${person.title} ${person.name} (${person.shiftTime})`;
          for (const dropdown of mdDropdowns) {
            if (!dropdown.value || dropdown.value === "") {
              if (![...dropdown.options].some(opt => opt.value === label)) { dropdown.appendChild(new Option(label, label)); }
              dropdown.value = label;
              staffAllocations[person.name] = "MD";
              e.source.postMessage({ type: "updateDesignation", name: person.name, theatre: "MD" }, "*");
              return;
            }
          }
        }
        alert(`No available slot or dropdown space in ${theatre}.`);
      });

      window.addEventListener("message", (e) => {
        if (e.data?.type === "unallocateStaffFromTheatre") {
          const { name, theatre } = e.data;
          const block = document.querySelector(`.theatre-block[data-theatre="${theatre}"]`);
          if (block) {
            const slots = block.querySelectorAll("[data-role]");
            for (const slot of slots) {
              if (slot.textContent.includes(name)) {
                const roleLabel = slot.getAttribute("data-role-label") || slot.getAttribute("data-role");
                slot.innerHTML = `<span class="name">${roleLabel}</span>`;
                slot.setAttribute("data-role-label", roleLabel);
                slot.setAttribute("data-assigned", "false");
                slot.removeAttribute("data-name");
                slot.removeAttribute("data-shift");
                slot.classList.add("staff-name");
                slot.classList.remove("allocated", "highlight");
                break;
              }
            }
          }
          const dropdownId = `dropdown-${theatre.toLowerCase()}`;
          const dropdown = document.getElementById(dropdownId);
          if (dropdown) {
            [...dropdown.options].forEach((opt, idx) => { if (opt.value.includes(name)) dropdown.remove(idx); });
            if (dropdown.value.includes(name)) dropdown.value = "";
          }
          if (theatre === "MD") {
            const mdDropdowns = document.querySelectorAll('[id^="md-staff-"]');
            for (const md of mdDropdowns) { if (md.value.includes(name)) md.value = ""; }
          }
          delete staffAllocations[name];
        }
      });

      let selectedForSwap = [];
      document.addEventListener("click", (e) => {
        const target = e.target.closest(".clickable-staff");
        if (!target) return;
        if (e.ctrlKey) {
          e.preventDefault();
          e.stopPropagation();
          const staffEntry = target.closest(".staff-entry");
          if (!staffEntry) return;
          staffEntry.style.backgroundColor = "#ffff66";
          selectedForSwap.push(staffEntry);
          if (selectedForSwap.length === 2) {
            const [el1, el2] = selectedForSwap;
            const span1 = el1.querySelector(".name");
            const span2 = el2.querySelector(".name");
            if (span1 && span2) {
              const temp = span1.innerHTML;
              span1.innerHTML = span2.innerHTML;
              span2.innerHTML = temp;
              const tempRole = el1.dataset.role;
              el1.dataset.role = el2.dataset.role;
              el2.dataset.role = tempRole;
              const name1 = el1.dataset.name;
              const name2 = el2.dataset.name;
              const theatre1 = el1.closest(".theatre-block")?.dataset.theatre;
              const theatre2 = el2.closest(".theatre-block")?.dataset.theatre;
              if (name1 && theatre2) staffAllocations[name1] = theatre2;
              if (name2 && theatre1) staffAllocations[name2] = theatre1;
              window.postMessage({ type: "updateDesignation", name: name1, theatre: theatre2 }, "*");
              window.postMessage({ type: "updateDesignation", name: name2, theatre: theatre1 }, "*");
            }
            selectedForSwap.forEach(el => el.style.backgroundColor = "");
            selectedForSwap = [];
          }
        } else {
          selectedForSwap.forEach(el => el.style.backgroundColor = "");
          selectedForSwap = [];
        }
      });

      document.addEventListener("dblclick", (e) => {
        const target = e.target;
        if (e.ctrlKey && target.classList.contains("clickable-staff")) {
          const name = target.dataset.name;
          const staffEntry = target.closest(".staff-entry");
          if (staffEntry) {
            const originalLabel = staffEntry.dataset.role || "Unassigned";
            const nameSpan = staffEntry.querySelector(".name");
            nameSpan.innerHTML = originalLabel;
            delete staffAllocations[name];
            window.postMessage({ type: "updateDesignation", name, theatre: "" }, "*");
          }
          target.style.backgroundColor = "";
        }
      });

      const block45871 = document.createElement("div");
      block45871.className = "theatre-block";
      block45871.setAttribute("data-theatre", "45871");
      const left45871 = document.createElement("div");
      left45871.className = "left-cell";
      left45871.innerHTML = `<div>45871</div>`;
      const right45871 = document.createElement("div");
      right45871.className = "right-cell";
      const dropdownWrapper45871 = document.createElement("div");
      dropdownWrapper45871.className = "stacked-label";
      const select45871 = document.createElement("select");
      select45871.id = "dropdown-45871";
      select45871.className = "stacked-input";
      select45871.innerHTML = `<option value=""></option><option>Upload DSR</option>`;
      dropdownWrapper45871.appendChild(select45871);
      right45871.appendChild(dropdownWrapper45871);
      block45871.appendChild(left45871);
      block45871.appendChild(right45871);
      column2.appendChild(block45871);
      let previousName45871 = "";
      select45871.addEventListener("change", () => {
        const selectedValue = select45871.value;
        const nameWithoutShift = selectedValue.replace(/\(.*?\)/, '').trim();
        const nameParts = nameWithoutShift.split(" ");
        const currentName = nameParts.slice(-2).join(" ");
        if (!selectedValue && previousName45871) {
          window.postMessage({ type: "unassignDesignation", name: previousName45871 }, "*");
          previousName45871 = "";
        } else if (currentName) {
          window.postMessage({ type: "updateDesignation", name: currentName, theatre: "45871" }, "*");
          previousName45871 = currentName;
        }
      });

      const blankBlock = document.createElement("div");
      blankBlock.className = "theatre-block";
      blankBlock.setAttribute("data-theatre", "Blank");
      const leftBlank = document.createElement("div");
      leftBlank.className = "left-cell";
      leftBlank.innerHTML = `<div>&nbsp;</div>`;
      const rightBlank = document.createElement("div");
      rightBlank.className = "right-cell";
      const dropdownWrapperBlank = document.createElement("div");
      dropdownWrapperBlank.className = "stacked-label";
      const selectBlank = document.createElement("select");
      selectBlank.id = "dropdown-blank";
      selectBlank.className = "stacked-input";
      selectBlank.innerHTML = `<option value=""></option><option>Upload DSR</option>`;
      dropdownWrapperBlank.appendChild(selectBlank);
      rightBlank.appendChild(dropdownWrapperBlank);
      blankBlock.appendChild(leftBlank);
      blankBlock.appendChild(rightBlank);
      column2.appendChild(blankBlock);
      let previousNameBlank = "";
      selectBlank.onchange = () => {
        const selectedValue = selectBlank.value;
        const isDefault = selectedValue === "" || selectedValue === "-- Select Staff --";
        if (isDefault && previousNameBlank) {
          window.postMessage({ type: "unassignDesignation", name: previousNameBlank }, "*");
          allocatedStaff.delete(previousNameBlank);
          previousNameBlank = "";
          return;
        }
        const nameWithoutShift = selectedValue.replace(/\(.*?\)/, "").trim();
        const nameParts = nameWithoutShift.split(" ");
        const currentName = nameParts.slice(-2).join(" ");
        if (currentName) {
          if (previousNameBlank && previousNameBlank !== currentName) {
            window.postMessage({ type: "unassignDesignation", name: previousNameBlank }, "*");
            allocatedStaff.delete(previousNameBlank);
          }
          window.postMessage({ type: "updateDesignation", name: currentName, theatre: "Shadowing" }, "*");
          allocatedStaff.add(currentName);
          previousNameBlank = currentName;
        }
      };

      [...Array(8).keys()].forEach((i) => {
        const block = createTheatreBlock(`ACAD ${i + 1}`);
        const staffList = block.querySelector('.staff-list');
        staffList.innerHTML = '';
        for (let j = 0; j < 2; j++) addStaffEntry(staffList, 'Scrub N/P');
        addStaffEntry(staffList, 'HCA');
        addStaffEntry(staffList, 'Anaes N/P');
        column2.appendChild(block);
        updateTheatreClosedStatus(block);
      });

      column2.appendChild(createTheatreBlock("Mile End"));
      const nightBlock = createTheatreBlock("Night");
      const nightStaffList = nightBlock.querySelector('.staff-list');
      nightStaffList.innerHTML = '';
      for (let i = 0; i < 7; i++) addStaffEntry(nightStaffList, 'Scrub N/P');
      for (let i = 0; i < 2; i++) addStaffEntry(nightStaffList, 'HCA');
      for (let i = 0; i < 3; i++) addStaffEntry(nightStaffList, 'Anaes N/P');
      column2.appendChild(nightBlock);
      updateTheatreClosedStatus(nightBlock);

      gridContainer.appendChild(column1);
      gridContainer.appendChild(column2);
      gridContainer.appendChild(column3);
    });

    function clearAllAllocations() {
      const assignedSpans = document.querySelectorAll('.assigned');
      assignedSpans.forEach(span => { span.textContent = ''; });
      if (window.opener) { window.opener.postMessage({ type: 'clearAllAllocations' }, '*'); }
    }

    function viewUploadedPDF(inputId) {
      const fileInput = document.getElementById(inputId);
      const file = fileInput.files[0];
      if (!file) { alert("No PDF uploaded yet."); return; }
      const blobUrl = URL.createObjectURL(file);
      window.open(blobUrl, "_blank");
    }

    let parsedRosterData = [];
    const allocatedStaff = new Set();
    const staffAllocationsGlobal = {};

    function sendClearToPopup() {
      if (win && !win.closed) { win.postMessage({ type: "clearAllAllocations" }, "*"); }
    }

    function setupDropdownUnassign(selectElement, theatreName) {
      if (!selectElement) return;
      selectElement.addEventListener("change", () => {
        const selectedValue = selectElement.value;
        const dropdownId = selectElement.id;
        const previousName = previousDropdownSelections.get(dropdownId);
        if (!selectedValue && previousName) {
          window.postMessage({ type: "unassignDesignation", name: previousName }, "*");
          allocatedStaff.delete(previousName);
          previousDropdownSelections.delete(dropdownId);
          return;
        }
        const nameWithoutShift = selectedValue.replace(/\(.*?\)/, "").trim();
        const nameParts = nameWithoutShift.split(" ");
        const currentName = nameParts.slice(-2).join(" ");
        if (currentName) {
          if (previousName && previousName !== currentName) {
            window.postMessage({ type: "unassignDesignation", name: previousName }, "*");
            allocatedStaff.delete(previousName);
          }
          window.postMessage({ type: "updateDesignation", name: currentName, theatre: theatreName }, "*");
          allocatedStaff.add(currentName);
          previousDropdownSelections.set(dropdownId, currentName);
        }
      });
    }

    function getParsedRosterData() { return parsedRosterData; }

    function allocateFromParsedRoster(person, theatreLabel, roleLabel) {
      const theatreBlock = document.querySelector(`[data-label="${theatreLabel}"]`);
      if (!theatreBlock) return;
      const slots = theatreBlock.querySelectorAll('.staff-name');
      for (let span of slots) {
        const currentLabel = span.getAttribute('data-role-label');
        const isUnassigned = !span.getAttribute("data-name") && !span.textContent.includes("(") && span.textContent.trim() === currentLabel;
        if (currentLabel === roleLabel && isUnassigned) {
          span.textContent = `${person.name} (${person.shift})`;
          span.classList.add('allocated');
          span.setAttribute('data-role', person.role);
          span.setAttribute('data-role-label', currentLabel);
          span.setAttribute('data-name', person.name);
          span.setAttribute('data-shift', person.shift);
          span.setAttribute('data-assigned', "true");
          if (window.parsedRosterWindow && !window.parsedRosterWindow.closed) {
            window.parsedRosterWindow.postMessage({ type: "updateDesignation", name: person.name, designation: theatreLabel }, "*");
          }
          return;
        }
      }
      alert(`No available slot found in ${theatreLabel} for ${roleLabel}.`);
    }

    async function parseUploadedExcel(file, uploadSource) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          const staffList = [];
          for (let i = 14; i < rows.length; i++) {
            const row = rows[i];
            if (!row || !row[12] || !row[6]) continue;
            const shiftTime = (row[6] || "").trim();
            const rawBand = (row[8] || "").toString().trim();
            const nameRaw = (row[12] || "").trim();
            const specialty = (row[2] || "").trim();
            let title = "", band = "";
            const match = rawBand.match(/^(\w+)\s+Band\s*(\d+)/i);
            if (match) { title = match[1].toUpperCase(); band = match[2]; }
            else { title = rawBand.split(" ")[0].toUpperCase(); band = rawBand.replace(/[^\d]/g, "") || ""; }
            const formattedName = nameRaw.includes(",") ? `${nameRaw.split(",")[1].trim().charAt(0)} ${nameRaw.split(",")[0].trim()}` : nameRaw;
            let role = "Scrub N/P";
            if (title === "HCA") role = "HCA";
            else if (uploadSource === "Anaes N/P") role = "Anaes N/P";
            if (band === "7") role = "Senior Team Lead";
            let team = "";
            if (uploadSource === "Anaes N/P") { team = "Anaesthetics"; }
            else if (shiftTime.startsWith("20:00")) { team = "NIGHT"; }
            else if (specialty) { team = specialty; }
            staffList.push({ role, title, name: formattedName, band, team, shiftTime, designation: "" });
          }
          resolve(staffList);
        };
        reader.readAsArrayBuffer(file);
      });
    }

    let scrubUploaded = false;
    let anaesUploaded = false;
    function checkShowButtons() {
      if (scrubUploaded && anaesUploaded) {
        document.getElementById('clearScrubBtn').style.display = 'inline-block';
        document.getElementById('clearODPBtn').style.display = 'inline-block';
        document.getElementById('viewStaffBtn').style.display = 'inline-block';
        document.getElementById('autoAllocateBtn').style.display = 'inline-block';
      } else {
        document.getElementById('clearScrubBtn').style.display = scrubUploaded ? 'inline-block' : 'none';
        document.getElementById('clearODPBtn').style.display = anaesUploaded ? 'inline-block' : 'none';
        document.getElementById('viewStaffBtn').style.display = 'none';
        document.getElementById('autoAllocateBtn').style.display = 'none';
      }
    }

    function clearUpload(inputId, linkContainerId, statusLabelId) {
      const input = document.getElementById(inputId);
      input.value = "";
      document.getElementById(linkContainerId).innerHTML = "";
      if (document.getElementById(statusLabelId)) { document.getElementById(statusLabelId).textContent = ""; }
      const roleToClear = inputId === 'fileInputScrub' ? 'Scrub N/P' : 'Anaes N/P';
      if (inputId === 'fileInputScrub') scrubUploaded = false;
      if (inputId === 'fileInputODP') anaesUploaded = false;
      const clearedNames = parsedRosterData.filter(p => p.role === roleToClear).map(p => p.name.toUpperCase());
      parsedRosterData = parsedRosterData.filter(p => p.role !== roleToClear);
      const staffElements = document.querySelectorAll('.theatre-block .staff-name');
      staffElements.forEach(el => {
        const assignedName = (el.getAttribute('data-name') || '').toUpperCase();
        if (clearedNames.includes(assignedName)) {
          el.textContent = el.getAttribute('data-role-label') || '';
          el.classList.remove('allocated');
          el.removeAttribute('data-name');
          el.removeAttribute('data-shift');
          el.removeAttribute('data-role');
        }
      });
      if (window.parsedRosterWindow && !window.parsedRosterWindow.closed) {
        window.parsedRosterWindow.postMessage({ type: "clearRoleByNames", names: clearedNames }, "*");
      }
      checkShowButtons();
    }

    async function handleExcelUpload(input, linkContainerId, statusLabelId, source) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        window.lastParsedSheet = json;
        document.getElementById(linkContainerId).innerHTML = `‚úÖ Upload Successful üëç <button onclick="previewExcelAsPDF()" style="background-color:#6a0dad;color:white;padding:6px 12px;border:none;border-radius:4px;font-size:16px;cursor:pointer;">View</button>`;
        document.getElementById(linkContainerId).style.color = "green";
        const parsed = await parseUploadedExcel(file, source);
        parsedRosterData = [...parsedRosterData, ...parsed];
        autoAssignTheatre(parsedRosterData);
        populateSpecialDropdowns();
        if (source === 'Scrub N/P') scrubUploaded = true;
        if (source === 'Anaes N/P') anaesUploaded = true;
        checkShowButtons();
      };
      reader.readAsArrayBuffer(file);
    }

    function previewExcelAsPDF() {
      const data = window.lastParsedSheet;
      if (!data || !Array.isArray(data)) return;
      let tableHTML = '<table style="width:100%; border-collapse:collapse; font-size:12px;">';
      data.forEach(row => {
        tableHTML += '<tr>';
        row.forEach(cell => { tableHTML += `<td style="border:1px solid #ccc; padding:6px;">${cell || ''}</td>`; });
        tableHTML += '</tr>';
      });
      tableHTML += '</table>';
      const newWin = window.open('', '_blank');
      newWin.document.write(`
        <html>
          <head>
            <title>Excel Preview</title>
            <style>
              body { font-family: Arial; padding: 20px; }
              table { width: 100%; border-collapse: collapse; }
              td { border: 1px solid #ccc; padding: 6px; font-size: 12px; }
            </style>
          </head>
          <body>${tableHTML}</body>
        </html>`);
      newWin.document.close();
    }

    const selectedStaff = new Set();
    function initializePage() {
      createTheatreBlocks();
      setTimeout(() => { populateSpecialDropdowns(); setupAllDropdownUnassignListeners(); attachDropdownChangeListeners(); }, 100);
    }

    function populateSpecialDropdowns() {
      const dropdown1490 = document.getElementById("dropdown-1490");
      const dropdown45871 = document.getElementById("dropdown-45871");
      const dropdownBlank = document.getElementById("dropdown-blank");
      const dropdown1494 = document.getElementById("dropdown-1494");
      if (!parsedRosterData.length) return;
      const seniorStaff = parsedRosterData.filter(p => (p.band === "6" || p.band === "7") && !p.shiftTime.startsWith("20:00"));
      const seniorScrubStaff = seniorStaff.filter(p => p.title === "RN" || (p.role && p.role === "Scrub N/P"));
      const anaestheticsSeniorStaff = seniorStaff.filter(p => p.team && p.team.toUpperCase().includes("ANAESTHETICS"));
      const band7Staff = parsedRosterData.filter(p => p.band === "7");
      function fillDropdown(dropdown, staffList) {
        if (!dropdown) return;
        const currentValue = dropdown.value;
        dropdown.innerHTML = `<option value="">-- Select Staff --</option>`;
        staffList.forEach(person => {
          const label = `${person.title} ${person.name} (${person.shiftTime})`;
          if (!selectedStaff.has(label) || label === currentValue) { dropdown.appendChild(new Option(label, label)); }
        });
        dropdown.value = [...dropdown.options].some(o => o.value === currentValue) ? currentValue : "";
      }
      fillDropdown(dropdown1490, seniorStaff);
      fillDropdown(dropdown45871, seniorStaff);
      fillDropdown(dropdownBlank, seniorScrubStaff);
      fillDropdown(dropdown1494, anaestheticsSeniorStaff);
      const mdDropdowns = document.querySelectorAll('[id^="md-staff-"]');
      mdDropdowns.forEach(dropdown => fillDropdown(dropdown, band7Staff));
      const floatersDropdowns = document.querySelectorAll('[id^="floaters-staff-"]');
      floatersDropdowns.forEach(dropdown => fillDropdown(dropdown, parsedRosterData));
    }

    function setupAllDropdownUnassignListeners() {
      setupDropdownUnassign(document.getElementById("dropdown-1490"), "1490");
      setupDropdownUnassign(document.getElementById("dropdown-1494"), "1494");
      setupDropdownUnassign(document.getElementById("dropdown-45871"), "45871");
      setupDropdownUnassign(document.getElementById("dropdown-blank"), "Blank");
      document.querySelectorAll('[id^="md-staff-"]').forEach(select => { setupDropdownUnassign(select, "MD"); });
      document.querySelectorAll('[id^="floaters-staff-"]').forEach(select => { setupDropdownUnassign(select, "Floater"); });
    }

    function setupDropdownUnassign(dropdown, label) {
      if (!dropdown) return;
      dropdown.addEventListener("change", () => {
        const selectedValue = dropdown.value;
        if (!selectedValue) return;
        const allDropdowns = Array.from(document.querySelectorAll("select"));
        for (const otherDropdown of allDropdowns) {
          if (otherDropdown !== dropdown && otherDropdown.value === selectedValue) {
            const conflictLabel = getDropdownLabel(otherDropdown);
            alert(`"${selectedValue}" is already allocated in ${conflictLabel}. Unallocate before reallocating.`);
            dropdown.value = "";
            return;
          }
        }
        updateSelectedStaff();
        populateSpecialDropdowns();
      });
    }

    function getDropdownLabel(dropdown) {
      const id = dropdown.id;
      if (id.includes("1490")) return "1490";
      if (id.includes("1494")) return "1494";
      if (id.includes("45871")) return "45871";
      if (id.includes("blank")) return "Blank";
      if (id.includes("md-staff")) return "MD";
      if (id.includes("floaters-staff")) return "Floater";
      return "Unknown";
    }

    function attachDropdownChangeListeners() {
      document.querySelectorAll('[id^="dropdown-"], [id^="md-staff-"], [id^="floaters-staff-"]').forEach(drop => {
        drop.addEventListener("change", () => { updateSelectedStaff(); populateSpecialDropdowns(); });
      });
    }

    function updateSelectedStaff() {
      selectedStaff.clear();
      document.querySelectorAll('[id^="dropdown-"], [id^="md-staff-"], [id^="floaters-staff-"]').forEach(drop => { if (drop.value) selectedStaff.add(drop.value); });
    }

    async function processBothExcels() {
      const scrubFile = document.getElementById("fileInputScrub").files[0];
      const odpFile = document.getElementById("fileInputODP").files[0];
      const scrubData = scrubFile ? await parseUploadedExcel(scrubFile, "Scrub N/P") : [];
      const odpData = odpFile ? await parseUploadedExcel(odpFile, "Anaes N/P") : [];
      parsedRosterData = [...scrubData, ...odpData];
      autoAssignTheatre(parsedRosterData);
      populateSpecialDropdowns();
    }

    function autoAssignTheatre(data) {
      const theatreMap = {
        "Theatre 7": ["Scrub N/P 1", "Scrub N/P 2", "Scrub N/P 3", "HCA 1", "Anaes N/P 1"],
        "Theatre 9": ["Scrub N/P 1", "Scrub N/P 2", "HCA 1", "Anaes N/P 1"],
        "Theatre 10": ["Scrub N/P 1", "Scrub N/P 2", "HCA 1", "Anaes N/P 1"],
        "Theatre 11": ["Scrub N/P 1", "Scrub N/P 2", "HCA 1", "Anaes N/P 1"],
        "Theatre 12": ["Scrub N/P 1", "Scrub N/P 2", "Scrub N/P 3", "HCA 1", "Anaes N/P 1"],
        "Night": ["Scrub N/P 1", "Scrub N/P 2", "Scrub N/P 3", "Scrub N/P 4", "Scrub N/P 5", "Scrub N/P 6", "Scrub N/P 7", "HCA 1", "HCA 2", "Anaes N/P 1", "Anaes N/P 2", "Anaes N/P 3"]
      };
      const slotFilled = {};
      const isAssigned = new Set();
      for (const theatre in theatreMap) { slotFilled[theatre] = {}; theatreMap[theatre].forEach(role => slotFilled[theatre][role] = false); }
      const theatreTeamRules = {
        "Theatre 9": { shift: "08:00-20:00", team: "Orthopaedics" },
        "Theatre 10": { shift: "08:00-20:00", team: "Orthopaedics" },
        "Theatre 11": { shift: "08:00-20:00", team: "Neurosurgery" },
        "Night": { shift: "20:00-08:30", team: null }
      };
      for (const theatre of ["Theatre 7", "Theatre 12"]) {
        for (const person of data) {
          const shift = person.shiftTime.replace(/\s+/g, '').replace(/‚Äì/g, '-');
          const nameKey = person.name + person.shiftTime;
          if (shift === "08:00-20:30" && person.role === "Scrub N/P" && person.name.includes("*") && !isAssigned.has(nameKey) && !slotFilled[theatre]["Scrub N/P 1"]) {
            assignToSlot(theatre, "Scrub N/P 1", person);
            slotFilled[theatre]["Scrub N/P 1"] = true;
            person.designation = theatre;
            isAssigned.add(nameKey);
          }
        }
      }
      for (const [theatre, { shift: requiredShift, team: requiredTeam }] of Object.entries(theatreTeamRules)) {
        for (const person of data) {
          const shift = person.shiftTime?.replace(/\s+/g, '').replace(/‚Äì/g, '-') || '';
          const nameKey = person.name + person.shiftTime;
          const team = person.team?.trim() || '';
          if (isAssigned.has(nameKey)) continue;
          const matchesShift = (shift === requiredShift) || (theatre === "Night" && shift === "20:30-08:30");
          if (!matchesShift) continue;
          if (requiredTeam && team !== requiredTeam) continue;
          if (person.role === "Scrub N/P" && person.name.includes("*") && !slotFilled[theatre]["Scrub N/P 1"]) {
            assignToSlot(theatre, "Scrub N/P 1", person);
            slotFilled[theatre]["Scrub N/P 1"] = true;
            person.designation = theatre;
            isAssigned.add(nameKey);
          }
        }
      }
      for (const person of data) {
        const shift = person.shiftTime.replace(/\s+/g, '').replace(/‚Äì/g, '-');
        const band = person.band;
        const role = person.role;
        const team = person.team?.trim() || '';
        const nameKey = person.name + person.shiftTime;
        if (isAssigned.has(nameKey)) continue;
        const theatresToCheck = (shift === "08:00-20:30") ? ["Theatre 7", "Theatre 12"] : (shift === "08:00-20:00") ? ["Theatre 9", "Theatre 10", "Theatre 11"] : (shift === "20:00-08:30" || shift === "20:30-08:30") ? ["Night"] : [];
        for (const theatre of theatresToCheck) {
          if (theatreTeamRules[theatre] && theatreTeamRules[theatre].team && team !== theatreTeamRules[theatre].team) { continue; }
          for (const slot of theatreMap[theatre]) {
            if (slotFilled[theatre][slot]) continue;
            if (isAssigned.has(nameKey)) break;
            if (slot.startsWith("Scrub N/P") && role === "Scrub N/P" && person.name.includes("*") && slot !== "Scrub N/P 1") continue;
            if (slot.startsWith("Scrub N/P") && role === "Scrub N/P" && (["5", "6"].includes(band))) {
              assignToSlot(theatre, slot, person);
              slotFilled[theatre][slot] = true;
              person.designation = theatre;
              isAssigned.add(nameKey);
              break;
            }
            if (slot.startsWith("HCA") && role === "HCA") {
              assignToSlot(theatre, slot, person);
              slotFilled[theatre][slot] = true;
              person.designation = theatre;
              isAssigned.add(nameKey);
              break;
            }
            if (slot.startsWith("Anaes N/P") && role === "Anaes N/P") {
              assignToSlot(theatre, slot, person);
              slotFilled[theatre][slot] = true;
              person.designation = theatre;
              isAssigned.add(nameKey);
              break;
            }
          }
        }
      }
    }

    function assignToSlot(theatreLabel, roleLabel, person) {
      const slot = document.querySelector(`[data-theatre="${theatreLabel}"] [data-role="${roleLabel}"]`);
      if (slot && person) {
        const title = person.title?.trim() || '';
        const name = person.name?.trim() || '';
        const shiftTime = person.shiftTime?.trim() || '';
        const profileUrl = person.profileUrl?.trim() || '#';
        if (!slot.querySelector(`[data-name="${name}"]`)) {
          slot.innerHTML = `
            <div class="staff-entry" data-role="${roleLabel}" data-name="${name}">
              <span class="clickable-staff name" data-name="${name}" style="white-space: nowrap;"><strong><a href="${profileUrl}" class="clickable-staff" data-name="${name}" style="text-decoration: none; color: inherit;">${title} ${name}</a></strong> (${shiftTime})</span>
            </div>`;
        }
      }
    }

    function assignBySpeciality(theatre, speciality, staffRoster) {
      const slots = document.querySelectorAll(`[data-theatre="${theatre}"] [data-role]`);
      const filled = new Set();
      for (const person of staffRoster) {
        if (!person.specialities || !person.specialities.includes(speciality)) continue;
        for (const slot of slots) {
          const roleLabel = slot.getAttribute("data-role");
          if (filled.has(roleLabel)) continue;
          if (roleLabel.startsWith(person.role)) { assignToSlot(theatre, roleLabel, person); filled.add(roleLabel); break; }
        }
      }
    }

    async function openHealthRosterWindow() {
      await processBothExcels();
      const win = window.open("", "_blank", "width=1000,height=700");
      const doc = win.document;
      doc.write(`
        <html>
          <head>
            <title>Daily Staffing Report</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 11px; }
              .roster-row, .roster-header { min-width: 1000px; width: max-content; display: grid; gap: 40px; align-items: center; font-size: 13px; padding: 6px 0; border-bottom: 1px solid #ccc; cursor: context-menu; transition: background-color 0.2s ease-in-out; }
              .roster-row { grid-template-columns: 220px 120px 200px 130px 130px 130px 130px; }
              .roster-row:hover { background-color: #e0ccff; }
              .roster-row.highlighted { background-color: #e0ccff; outline: 2px solid #e0ccff; }
              .roster-row.allocated-row { background-color: #fff9c4; border-left: 4px solid #ffd700; }
              .roster-header { grid-template-columns: 210px 150px 170px 160px 170px 95px 130px; font-weight: bold; background-color: #f0f0f0; color: #000; padding: 10px 16px; border-radius: 12px; box-shadow: inset 0 2px 4px rgba(255,255,255,0.2), inset 0 -2px 4px rgba(0,0,0,0.2), 0 2px 6px rgba(0,0,0,0.2); }
              .roster-header > div { transition: color 0.2s ease; cursor: pointer; }
              .roster-header > div:hover { color: #B026FF; }
              h2 { background-color: #005EB8; color: white; padding: 40px 20px; border-radius: 8px; font-size: 30px; width: 100%; box-sizing: border-box; margin: 0 auto 20px auto; box-shadow: inset 0 1px 2px rgba(255,255,255,0.2), inset 0 -1px 2px rgba(0,0,0,0.2), 0 2px 5px rgba(0,0,0,0.2); }
              #contextMenu { position: absolute; display: none; background: white; border: 1px solid #ccc; box-shadow: 2px 2px 6px rgba(0,0,0,0.2); z-index: 1000; min-width: 150px; }
              #contextMenu > div { padding: 8px 12px; cursor: pointer; position: relative; }
              #contextMenu > div:hover { background-color: #e0ccff; }
              .submenu-item { background: white; color: black; padding: 8px 12px; cursor: pointer; position: relative; }
              .submenu-item:hover { background-color: #e0ccff; }
              .submenu { display: none; position: absolute; top: 0; left: 100%; background: white; color: black; border: 1px solid #ccc; z-index: 1001; min-width: 150px; }
              .submenu-item:hover > .submenu { display: block; }
            </style>
          </head>
          <body>
            <div style="max-width: 1200px; margin: 0 auto;">
              <h2>Daily Staffing Report</h2>
              <input id="searchBox" type="text" placeholder="Search staff by name, role, or team..." style="margin-bottom: 13px; font-size: 16px; padding: 8px; width: 40ch; max-width: 100%; border: 1px solid #ccc; border-radius: 6px;" />
              <div id="staffSummary" style="margin-bottom: 16px; font-size: 13px; font-weight: 500; color: #333; background: #f9f9f9; padding: 10px 16px; border: 1px solid #ddd; border-radius: 6px; width: fit-content; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></div>
              <div style="margin-bottom: 12px;"><button id="addStaffBtn" style="margin-right: 12px; font-size: 14px; padding: 6px 12px;">‚ûï Add Staff</button><button id="removeStaffBtn" style="font-size: 14px; padding: 6px 12px;">‚ûñ Remove Staff</button></div>
              <div style="overflow-y: auto; max-height: 70vh;">
                <div class="roster-header" style="position: sticky; top: 0; background: white; z-index: 1; display: grid; font-weight: bold;">
                  <div data-key="role">Role</div>
                  <div data-key="title">Title</div>
                  <div data-key="name">Name</div>
                  <div data-key="band">Band</div>
                  <div data-key="team">Team</div>
                  <div data-key="shiftTime">Shift</div>
                  <div data-key="designation">Designation</div>
                </div>
                <div id="rosterBody"></div>
              </div>
              <div id="contextMenu"></div>
            </div>
          </body>
        </html>`);
      doc.close();

      setTimeout(() => {
        const rosterBody = win.document.getElementById("rosterBody");
        const contextMenu = win.document.getElementById("contextMenu");
        const searchInput = win.document.getElementById("searchBox");
        const summaryDiv = win.document.getElementById("staffSummary");
        let selectedIndex = null;
        let editingIndex = null;
        let sortKey = null;
        let sortOrder = 1;
        let filterText = "";

        searchInput.addEventListener("input", () => { filterText = searchInput.value.trim().toLowerCase(); renderRoster(); });
        if (parsedRosterData.length === 0) { rosterBody.innerHTML = `<div style="grid-column: span 6; font-size: 14px; color: red;">No staff parsed. Please upload the Daily Health Roster.</div>`; return; }

        function updateStaffSummary(filteredData) {
          const roles = [
            { role: "Scrub N/P", emoji: "üë®‚Äç‚öïÔ∏è", label: "Scrub N/P Staff" },
            { role: "HCA", emoji: "üßë‚Äçüîß", label: "HCA Staff" },
            { role: "Anaes N/P", emoji: "üßë‚Äç‚öïÔ∏è", label: "Anaes N/P Staff" }
          ];
          let summaryHTML = `<div style="display: flex; gap: 16px; justify-content: start; flex-wrap: wrap;">`;
          roles.forEach(({ role, emoji, label }) => {
            const people = filteredData.filter(p => p.role === role);
            const allocated = people.filter(p => p.designation?.trim()).length;
            const unallocated = people.length - allocated;
            summaryHTML += `
              <div style="background: #f4f4f4; border: 1px solid #ccc; border-radius: 8px; padding: 12px 16px; min-width: 180px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); font-size: 16px;">
                <div style="font-weight: 600; margin-bottom: 6px;">${emoji} ${label}: ${people.length}</div>
                <div style="margin-left: 10px;">
                  <div><span style="color: green;">‚úÖ Allocated:</span> ${allocated}</div>
                  <div><span style="color: red;">üö´ Unallocated:</span> ${unallocated}</div>
                </div>
              </div>`;
          });
          summaryHTML += "</div>";
          summaryDiv.innerHTML = summaryHTML;
        }

        function normalizeName(name) { return name.replace(/^RN\s+/i, "").replace(/\s+/g, " ").trim(); }

        function renderRoster() {
          if (!parsedRosterData || parsedRosterData.length === 0) { rosterBody.innerHTML = `<div style="grid-column: span 6; font-size: 12px; color: red;">No staff parsed. Please check the uploaded PDFs or Excel.</div>`; return; }
          let filteredData = parsedRosterData;
          if (filterText) {
            filteredData = parsedRosterData.filter(p => (p.role || "").toLowerCase().includes(filterText) || (p.title || "").toLowerCase().includes(filterText) || (p.name || "").toLowerCase().includes(filterText) || (p.team || "").toLowerCase().includes(filterText) || (p.shiftTime || "").toLowerCase().includes(filterText) || (p.designation || "").toLowerCase().includes(filterText));
          }
          if (sortKey) {
            parsedRosterData.sort((a, b) => {
              if (a.name === "New Staff") return -1;
              if (b.name === "New Staff") return 1;
              const valA = (a[sortKey] || "").toString().toUpperCase();
              const valB = (b[sortKey] || "").toString().toUpperCase();
              return valA.localeCompare(valB) * sortOrder;
            });
          }
          rosterBody.innerHTML = "";
          updateStaffSummary(filteredData);
          filteredData.forEach((p, i) => {
            const actualIndex = parsedRosterData.indexOf(p);
            const row = win.document.createElement("div");
            row.className = "roster-row";
            row.dataset.index = actualIndex;
            if (p.designation && p.designation !== "") { row.classList.add("allocated-row"); }
            const isEditing = actualIndex === editingIndex;
            row.innerHTML = `
              <div><button onclick="editRosterRow(${actualIndex})" style="border:none; background:none; cursor:pointer;" title="${isEditing ? 'Save' : 'Edit'}">${isEditing ? "üíæ" : "‚úèÔ∏è"}</button>${isEditing ? `<input id="edit-role-${actualIndex}" value="${p.role}" style="width:100px; font-size:12px; font-family:inherit;">` : p.role}</div>
              <div>${isEditing ? `<input id=\"edit-title-${actualIndex}\" value=\"${p.title}\" style=\"width:80px; font-size:12px; font-family:inherit;\">` : p.title}</div>
              <div>${isEditing ? `<input id=\"edit-name-${actualIndex}\" value=\"${p.name}\" style=\"width:130px; font-size:12px; font-family:inherit;\">` : p.name}</div>
              <div>${isEditing ? `<input id=\"edit-band-${actualIndex}\" value=\"${p.band}\" style=\"width:60px; font-size:12px; font-family:inherit;\">` : p.band}</div>
              <div>${isEditing ? `<input id=\"edit-team-${actualIndex}\" value=\"${p.team}\" style=\"width:120px; font-size:12px; font-family:inherit;\">` : (p.team || "")}</div>
              <div>${isEditing ? `<input id=\"edit-shift-${actualIndex}\" value=\"${p.shiftTime}\" style=\"width:120px; font-size:12px; font-family:inherit;\">` : (p.shiftTime || "")}</div>
              <div>${p.designation || ""}</div>`;
            if (isEditing) {
              row.querySelectorAll("input").forEach(input => {
                input.addEventListener("keydown", (e) => {
                  if (e.key === "Enter") { saveEdits(actualIndex); }
                  else if (e.key === "Escape") { editingIndex = null; renderRoster(); }
                });
              });
            }
            row.addEventListener("click", () => {
              selectedIndex = actualIndex;
              win.document.querySelectorAll(".roster-row").forEach(r => r.classList.remove("highlighted"));
              row.classList.add("highlighted");
            });
            row.addEventListener("contextmenu", (e) => {
              e.preventDefault();
              selectedIndex = actualIndex;
              win.document.querySelectorAll(".roster-row").forEach(r => r.classList.remove("highlighted"));
              row.classList.add("highlighted");
              buildContextMenu(e.pageX, e.pageY);
            });
            rosterBody.appendChild(row);
          });
        }

        const headerCells = win.document.querySelectorAll(".roster-header > div");
        headerCells.forEach(cell => {
          const key = cell.dataset.key;
          cell.addEventListener("click", () => { if (sortKey === key) { sortOrder *= -1; } else { sortKey = key; sortOrder = 1; } renderRoster(); });
        });

        function saveEdits(index) {
          const person = parsedRosterData[index];
          person.role = win.document.getElementById(`edit-role-${index}`).value;
          person.title = win.document.getElementById(`edit-title-${index}`).value;
          person.name = win.document.getElementById(`edit-name-${index}`).value;
          person.band = win.document.getElementById(`edit-band-${index}`).value;
          person.team = win.document.getElementById(`edit-team-${index}`).value;
          person.shiftTime = win.document.getElementById(`edit-shift-${index}`).value;
          editingIndex = null;
          renderRoster();
        }
        win.editRosterRow = function(index) { if (editingIndex === index) { saveEdits(index); } else { editingIndex = index; renderRoster(); } };
        win.document.getElementById("addStaffBtn").addEventListener("click", () => { parsedRosterData.unshift({ role: "Scrub N/P", title: "RN", name: "New Staff", band: "5", team: "", shiftTime: "", designation: "" }); renderRoster(); });
        win.document.getElementById("removeStaffBtn").addEventListener("click", () => { if (selectedIndex !== null && parsedRosterData[selectedIndex]) { parsedRosterData.splice(selectedIndex, 1); selectedIndex = null; renderRoster(); } else { alert("Please select a staff row first."); } });
        renderRoster();

        window.addEventListener("message", (e) => {
          if (e.data?.type === "newRoleAdded") {
            const { theatre, role } = e.data.payload;
            if (!dynamicRoleMap[theatre]) dynamicRoleMap[theatre] = [];
            if (!dynamicRoleMap[theatre].includes(role)) { dynamicRoleMap[theatre].push(role); }
          }
        });

        window.addEventListener("message", (e) => {
          if (e.data?.type === "updateDesignation") {
            const { name, theatre } = e.data;
            const normalizedName = normalizeName(name);
            const person = parsedRosterData.find(p => normalizeName(p.name) === normalizedName);
            if (person) { person.designation = theatre; renderRoster(); }
          }
        });

        window.addEventListener("message", (e) => {
          if (e.data?.type === "unassignDesignation") {
            const { name } = e.data;
            const person = parsedRosterData.find(p => p.name === name);
            if (person) { person.designation = ""; renderRoster(); }
          }
        });

        window.addEventListener("message", (e) => {
          if (e.data?.type === "clearAllAllocations") { parsedRosterData.forEach(p => p.designation = ""); renderRoster(); }
          if (e.data?.type === "clearRoleByNames" && Array.isArray(e.data.names)) {
            const namesToClear = e.data.names.map(n => n.toUpperCase());
            parsedRosterData.forEach(p => { if (namesToClear.includes(p.name.toUpperCase())) { p.designation = ""; } });
            renderRoster();
          }
        });

        function buildContextMenu(x, y) {
          contextMenu.innerHTML = "";
          const actions = ["Allocate", "Unallocate"];
          const floorStructure = {
            "4th Floor (Day)": ["Theatre 1", "Theatre 2", "Theatre 3", "Theatre 4", "Theatre 5", "Theatre 6", "Theatre 7", "Theatre 8", "Theatre 9", "Theatre 10", "Theatre 11", "Theatre 12"],
            "4th Floor (Night)": "roles",
            "3rd Floor": ["ACAD 1", "ACAD 2", "ACAD 3", "ACAD 4", "ACAD 5", "ACAD 6", "ACAD 7", "ACAD 8"],
            "Mile End": "roles"
          };
          actions.forEach(action => {
            const div = win.document.createElement("div");
            div.textContent = action;
            div.className = "submenu-item";
            if (action === "Allocate") {
              const floorMenu = win.document.createElement("div");
              floorMenu.className = "submenu";
              Object.entries(floorStructure).forEach(([floor, items]) => {
                const floorDiv = win.document.createElement("div");
                floorDiv.textContent = floor;
                floorDiv.className = "submenu-item";
                floorDiv.style.position = "relative";
                const levelMenu = win.document.createElement("div");
                levelMenu.className = "submenu";
                if (Array.isArray(items)) {
                  items.forEach(theatre => {
                    const theatreDiv = win.document.createElement("div");
                    theatreDiv.textContent = theatre;
                    theatreDiv.className = "submenu-item";
                    theatreDiv.style.position = "relative";
                    theatreDiv.addEventListener("mouseenter", () => {
                      if (theatreDiv.querySelector(".submenu")) return;
                      const roleMenu = win.document.createElement("div");
                      roleMenu.className = "submenu";
                      const roles = getRolesForTheatre(theatre);
                      const sortedRoles = sortRoles(roles);
                      sortedRoles.forEach(role => {
                        const roleDiv = win.document.createElement("div");
                        roleDiv.className = "submenu-item";
                        roleDiv.textContent = role;
                        roleDiv.addEventListener("click", () => {
                          const p = parsedRosterData[selectedIndex];
                          win.opener.postMessage({ type: "allocateStaffToTheatre", person: p, theatre, role }, "*");
                          win.document.querySelectorAll(".roster-row").forEach(r => r.classList.remove("highlighted"));
                          hideContextMenu();
                        });
                        roleMenu.appendChild(roleDiv);
                      });
                      theatreDiv.appendChild(roleMenu);
                    });
                    levelMenu.appendChild(theatreDiv);
                  });
                } else if (items === "roles") {
                  floorDiv.addEventListener("mouseenter", () => {
                    if (floorDiv.querySelector(".submenu")) return;
                    const roleMenu = win.document.createElement("div");
                    roleMenu.className = "submenu";
                    const roles = getRolesForTheatre(floor);
                    const sortedRoles = sortRoles(roles);
                    sortedRoles.forEach(role => {
                      const roleDiv = win.document.createElement("div");
                      roleDiv.className = "submenu-item";
                      roleDiv.textContent = role;
                      roleDiv.addEventListener("click", () => {
                        const p = parsedRosterData[selectedIndex];
                        win.opener.postMessage({ type: "allocateStaffToTheatre", person: p, theatre: floor, role }, "*");
                        win.document.querySelectorAll(".roster-row").forEach(r => r.classList.remove("highlighted"));
                        hideContextMenu();
                      });
                      roleMenu.appendChild(roleDiv);
                    });
                    floorDiv.appendChild(roleMenu);
                  });
                }
                if (Array.isArray(items)) { floorDiv.appendChild(levelMenu); }
                floorMenu.appendChild(floorDiv);
              });
              div.appendChild(floorMenu);
            }
            if (action === "Unallocate") {
              div.addEventListener("click", () => {
                const p = parsedRosterData[selectedIndex];
                if (!p.designation) return;
                const oldTheatre = p.designation;
                p.designation = "";
                renderRoster();
                win.opener.postMessage({ type: "unallocateStaffFromTheatre", name: p.name, theatre: oldTheatre }, "*");
                win.document.querySelectorAll(".roster-row").forEach(r => r.classList.remove("highlighted"));
                hideContextMenu();
              });
            }
            contextMenu.appendChild(div);
          });
          contextMenu.style.display = "block";
          contextMenu.style.top = `${y}px`;
          contextMenu.style.left = `${x}px`;
        }

        function getRolesForTheatre(theatre) {
          const roles = [];
          for (let i = 1; i <= 7; i++) { roles.push(`Scrub N/P ${i}`); }
          for (let i = 1; i <= 5; i++) { roles.push(`HCA ${i}`); roles.push(`Anaes N/P ${i}`); }
          roles.push("Cell Salvage");
          return roles;
        }

        function hideContextMenu() { contextMenu.style.display = "none"; }

        function handleAction(action) {
          if (selectedIndex === null) return;
          const p = parsedRosterData[selectedIndex];
          if (action === "Unallocate") {
            if (!p.designation) return;
            win.opener.postMessage({ type: "unallocateStaffFromTheatre", name: p.name, theatre: p.designation }, "*");
            p.designation = "";
            renderRoster();
            win.document.querySelectorAll(".roster-row").forEach(r => r.classList.remove("highlighted"));
            hideContextMenu();
          }
        }

        win.document.addEventListener("click", hideContextMenu);
        renderRoster();
      }, 100);
    }

    function sortRoles(roles) {
      const group = (base) => {
        const exact = roles.filter(r => r === base);
        const numbered = roles.filter(r => r.startsWith(base + " ") && !isNaN(r.split(" ").pop())).sort((a, b) => parseInt(a.split(" ").pop()) - parseInt(b.split(" ").pop()));
        return [...exact, ...numbered];
      };
      const others = roles.filter(r => !r.startsWith("Scrub N/P") && !r.startsWith("Anaes N/P") && !r.startsWith("HCA")).sort();
      return [...group("Scrub N/P"), ...group("Anaes N/P"), ...group("HCA"), ...others];
    }

    function allocateStaff(index) {
      const person = parsedRosterData[index];
      alert(`Allocate ${person.name} as ${person.role} to a Theatre block`);
    }
  </script>

  <script>
    function saveAllocationsToJSON() {
      const assignments = [];
      document.querySelectorAll(".staff-entry").forEach(entry => {
        const role = entry.dataset.role;
        const name = entry.dataset.name;
        const theatre = entry.closest("[data-theatre]")?.dataset.theatre;
        if (name && role && theatre) { assignments.push({ name, role, theatre }); }
      });
      const blob = new Blob([JSON.stringify(assignments, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "allocation_snapshot.json";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>

  <script>
    function saveCurrentViewWithState() {
      const clonedBody = document.body.cloneNode(true);
      clonedBody.querySelectorAll("script, input[type='file']").forEach(el => el.remove());
      clonedBody.querySelectorAll("select").forEach(select => {
        const selected = select.selectedIndex;
        Array.from(select.options).forEach((opt, i) => { if (i === selected) opt.setAttribute("selected", "selected"); else opt.removeAttribute("selected"); });
      });
      clonedBody.querySelectorAll("input[type='date'], input[type='text']").forEach(input => { input.setAttribute("value", input.value); });
      const styles = Array.from(document.querySelectorAll("style")).map(style => style.innerHTML).join("\n");
      const html = `
        <!DOCTYPE html>
        <html>
          <head>
            <meta charset=\"UTF-8\">
            <meta name=\"author\" content=\"Alex Monterubio\" />
            <title>RLH Theatre Allocation Snapshot</title>
            <style>${styles}</style>
          </head>
          <body>${clonedBody.innerHTML}</body>
        </html>`;
      const today = new Date().toISOString().split("T")[0];
      const filename = `RLH_Theatre_Allocation_${today}.html`;
      const blob = new Blob([html], { type: "text/html" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>

  <footer>Author: Alex Monterubio</footer>
</body>
</html>
